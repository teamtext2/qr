<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Text2 - QR Scan</title>
  <style>
    body{margin:0;font-family:sans-serif;background:#0f1115;color:#FFFFFF;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:12px}
    .card{background:#151922;padding:20px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.6);width:100%;max-width:1040px}
    .title{margin:0 0 14px;font-size:20px;font-weight:800;letter-spacing:.2px}
    .subtitle{margin:0 0 16px;color:#a9b1c6;font-size:13px}
    .grid{display:grid;gap:16px}
    @media(min-width:768px){.grid{grid-template-columns:1.2fr .8fr;align-items:start}}
    .panel{background:#0f131b;border:1px solid #222836;border-radius:12px;padding:14px}
    .panel h3{margin:0 0 10px;font-size:14px;color:#a9b1c6;font-weight:700}
    .media{position:relative}
    video{width:100%;border-radius:12px;border:1px solid #222836;background:#0b0e13}
    .preview{margin-top:10px;border-radius:12px;overflow:hidden;border:1px solid #222836;background:#0b0e13}
    .preview img{display:block;width:100%;height:auto}
    canvas{display:none}
    .btn{margin:6px 4px;padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:700;letter-spacing:.2px}
    .primary{background:#1E90FF;color:#FFFFFF;box-shadow:0 6px 18px rgba(30,144,255,.25)}
    .primary:active{transform:translateY(1px)}
    .ghost{background:transparent;border:1px solid #3b4252;color:#c7d0e4}
    .muted{background:#0f131b;border:1px solid #222836;color:#a9b1c6}
    .btns{display:flex;flex-wrap:wrap;justify-content:center}
    #output{
      margin-top:12px;
      word-break:break-all;
      background:linear-gradient(135deg, #1a1f2e 0%, #0f131b 100%);
      border:2px solid #1E90FF;
      padding:16px;
      border-radius:12px;
      font-size:15px;
      color:#e6e9f2;
      min-height:50px;
      box-shadow:0 0 20px rgba(30,144,255,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
      position:relative;
      font-weight:500;
      line-height:1.4;
    }
    #output:before{
      content:'';
      position:absolute;
      top:-2px;
      left:-2px;
      right:-2px;
      bottom:-2px;
      background:linear-gradient(45deg, #1E90FF, #00BFFF, #1E90FF);
      border-radius:12px;
      z-index:-1;
      animation:glow 2s ease-in-out infinite alternate;
    }
    @keyframes glow{
      0%{opacity:0.5}
      100%{opacity:0.8}
    }
    .hint{margin-top:8px;font-size:12px;color:#8792a8}
  </style>
</head>
<body>
  <div class="card">
    <h2 class="title">Text2 QR Scan</h2>
    <p class="subtitle">Scan QR codes using camera or upload images from gallery.</p>
    <div class="grid">
      <div class="panel">
        <h3>Camera / Image</h3>
        <div class="media">
          <video id="video" autoplay playsinline></video>
          <canvas id="canvas"></canvas>
        </div>
        <div class="btns">
          <button class="btn primary" id="startCam">Start Camera</button>
          <label class="btn ghost">Upload Image<input type="file" id="fileInput" accept="image/*" hidden></label>
        </div>
        <div class="preview" id="previewBox" style="display:none">
          <img id="previewImg" alt="Selected QR image">
        </div>
        <div class="hint">Thank you for using Text2 services</div>
      </div>
      <div class="panel">
        <h3>Result</h3>
        <div id="output">No data available</div>
        <div style="text-align:center">
          <button class="btn ghost" id="copyBtn">Copy</button>
          <button class="btn muted" id="openBtn">Open Link</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const video=document.getElementById('video');
    const canvas=document.getElementById('canvas');
    const ctx=canvas.getContext('2d');
    const startCam=document.getElementById('startCam');
    const fileInput=document.getElementById('fileInput');
    const output=document.getElementById('output');
    const copyBtn=document.getElementById('copyBtn');
    const openBtn=document.getElementById('openBtn');
    const previewBox=document.getElementById('previewBox');
    const previewImg=document.getElementById('previewImg');

    let stream,lastResult='';
    let detector;

    async function initDetector(){
      if('BarcodeDetector' in window){
        detector=new BarcodeDetector({formats:['qr_code']});
      }else{
        await loadJsQR();
      }
    }
    function loadJsQR(){
      return new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://unpkg.com/jsqr/dist/jsQR.js';
        s.onload=()=>res();s.onerror=()=>rej();
        document.head.appendChild(s);
      });
    }

    async function startCamera(){
      stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      video.srcObject=stream;
      requestAnimationFrame(tick);
    }

    async function tick(){
      if(!video.videoWidth) return requestAnimationFrame(tick);
      canvas.width=video.videoWidth;canvas.height=video.videoHeight;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      if(detector){
        const bitmap=await createImageBitmap(canvas);
        const codes=await detector.detect(bitmap);
        if(codes.length) showResult(codes[0].rawValue);
      }else if(window.jsQR){
        const img=ctx.getImageData(0,0,canvas.width,canvas.height);
        const code=jsQR(img.data,img.width,img.height);
        if(code) showResult(code.data);
      }
      requestAnimationFrame(tick);
    }

    function showResult(txt){lastResult=txt;output.textContent=txt;}
    startCam.onclick=()=>{initDetector().then(startCamera)};

    // Initialize detector when page loads to enable scanning uploaded images
    initDetector();

    fileInput.onchange=async e=>{
      const f=e.target.files[0];if(!f)return;
      // Ensure detector is ready or jsQR is loaded before processing image
      await initDetector();
      const url=URL.createObjectURL(f);
      // Display image immediately
      previewImg.src=url;previewBox.style.display='block';
      const img=new Image();
      img.onload=async()=>{
        canvas.width=img.width;canvas.height=img.height;ctx.drawImage(img,0,0);
        if(detector){
          try{
            const bitmap=await createImageBitmap(canvas);
            const codes=await detector.detect(bitmap);
            if(codes.length){
              showResult(codes[0].rawValue);
              return;
            }
          }catch{}
        }
        if(window.jsQR){
          const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
          const code=jsQR(imgData.data,imgData.width,imgData.height);
          if(code){
            showResult(code.data);
            return;
          }
        }
        output.textContent='No QR code detected in image.';
      };
      img.src=url;
    };

    copyBtn.onclick=()=>{if(lastResult)navigator.clipboard.writeText(lastResult)};
    openBtn.onclick=()=>{if(lastResult)window.open(lastResult,'_blank')};
  </script>
</body>
</html>
